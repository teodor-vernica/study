<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Page</title>
    <link rel="stylesheet" href="../page-templates/task-page.css">
    <script src="../../../revisitUtilities/revisit-communicate.js"></script>
    <script type="module">
        import {Registry, initializeTrrack} from 'https://cdn.jsdelivr.net/npm/@trrack/core@1.3.0/+esm'

        const initialState = {
            selectedButton: 'task-description'
        };

        const registry = Registry.create();

        const clickButton = registry.register(
            'click-tab',
            (state, task) => {
                state.selectedButton = task;
                return state;
            }
        );

        const trrack = initializeTrrack({
            initialState,
            registry
        });

        window.showContent = function(page, button) {
            document.querySelectorAll('.content').forEach(div => div.style.display = 'none');
            document.getElementById(page).style.display = 'block';
            document.querySelectorAll('.tab').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            console.log('Button ID:', page);

            trrack.apply('Change data view', clickButton(page));

            // Save the current state to ReVISit
            saveToReVISit();
        }

        trrack.currentChange(() => {
            const selectedButton = trrack.getState().selectedButton;
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('onclick').includes(selectedButton));
            });
            document.querySelectorAll('.content').forEach(div => {
                div.style.display = div.id === selectedButton ? 'block' : 'none';
            });

            // Save the current state to ReVISit
            saveToReVISit();
        });

        function saveToReVISit() {
            Revisit.postAnswers({
                selectedButton: trrack.getState().selectedButton
            });
            Revisit.postProvenance(trrack.graph.backend);
        }

        // Call saveToReVISit when the page is about to unload (e.g., when closing the tab)
        window.addEventListener('beforeunload', saveToReVISit);
    </script>
</head>
<body>
    <div class="tabs">
        <div class="tab active" onclick="showContent('task-description', this)">Task description</div>
        <div class="tab" onclick="showContent('cad-model', this)">CAD model</div>
    </div>
    <div id="task-description" class="content">
        <iframe src="task-description-training.html" width="100%" height="500px"></iframe>
    </div>
    <div id="cad-model" class="content">
        <iframe src="model-viewer-training.html" width="100%" height="500px"></iframe>
    </div>
</body>
</html>
